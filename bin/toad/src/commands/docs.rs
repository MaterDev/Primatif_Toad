use crate::cli::Cli;
use anyhow::Result;
use clap::CommandFactory;
use colored::*;
use std::fs;
use std::path::PathBuf;

pub fn handle(version: &str) -> Result<()> {
    println!("Generating programmatic CLI documentation...");
    let mut cmd = Cli::command();
    let help = cmd.render_help().to_string();

    let mut output = String::new();
    output.push_str(
        "# Toad CLI Reference

",
    );
    output.push_str(&format!(
        "> **Version:** `v{}`  
",
        version
    ));
    output.push_str(
        "> **Generated by:** `toad docs`  
",
    );
    output.push_str(
        "> **Last Updated:** 2026-02-09  

",
    );
    output.push_str(
        "```text
",
    );
    output.push_str(&help);
    output.push_str(
        "
```
",
    );

    let docs_path = PathBuf::from("docs/guides/CLI.md");
    if let Some(parent) = docs_path.parent() {
        fs::create_dir_all(parent)?;
    }
    fs::write(&docs_path, output)?;
    println!(
        "{} Documentation updated at: {:?}",
        "SUCCESS:".green().bold(),
        docs_path
    );
    Ok(())
}
