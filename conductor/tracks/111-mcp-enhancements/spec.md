# Specification: MCP Enhancements (111-mcp-enhancements)

## Overview

Enhance the MCP server with missing tools that provide direct access to key artifacts (ATLAS, MANIFEST, project CONTEXT) and improve the developer experience with better documentation and examples.

## Sources

- **Pre-release Review:** Final v1.1.0 check findings
- **MCP Spec:** <https://modelcontextprotocol.io/specification/2025-11-25>
- **Existing Implementation:** `bin/toad-mcp/src/server.rs`

---

## Goals

1. **Complete the MCP Tool Surface** — Add missing tools for direct artifact access
2. **Improve Documentation** — Update MCP guide with all tools and common workflows
3. **Enhance Discoverability** — Ensure AI agents can find what they need in 1-2 tool calls

---

## Non-Goals

- Batch operations (deferred to v1.2.0)
- HTTP transport (stdio is sufficient for v1.1.0)
- Prompt templates (future enhancement)

---

## Architecture Decisions

### AD-1: Direct Artifact Access

Add three new tools that return raw artifact content:

```rust
#[tool(description = "Get the full architectural atlas (DNA map for all projects)")]
pub async fn get_atlas(&self, _params: Parameters<NoParams>) -> Result<CallToolResult, McpError>

#[tool(description = "Get the full ecosystem manifest")]
pub async fn get_manifest(&self, _params: Parameters<NoParams>) -> Result<CallToolResult, McpError>

#[tool(description = "Get detailed context for a specific project")]
pub async fn get_project_context(&self, params: Parameters<GetProjectDetailParams>) -> Result<CallToolResult, McpError>
```

**Rationale:**
- AI agents currently need multiple tool calls to piece together context
- Direct access to `ATLAS.json`, `MANIFEST.md`, and `CONTEXT.md` is more efficient
- These files are already generated by `toad manifest` — we just expose them

### AD-2: Read from Shadows Directory

All three tools read from `workspace.shadows_dir`:
- `ATLAS.json` → `~/.toad/shadows/ATLAS.json`
- `MANIFEST.md` → `~/.toad/shadows/MANIFEST.md`
- `CONTEXT.md` → `~/.toad/shadows/{project_name}/CONTEXT.md`

If files don't exist, return a helpful error suggesting `toad manifest`.

### AD-3: Documentation-First Approach

Update `docs/guides/MCP.md` to include:
1. **Complete tool list** (including context management tools)
2. **Common workflows** section with examples
3. **Troubleshooting** tips for missing artifacts

---

## Implementation Plan

### Phase 1: Add Missing Tools (20 min)

**File:** `bin/toad-mcp/src/server.rs`

1. Add `get_atlas` tool:

   ```rust
   #[tool(description = "Get the full architectural atlas (DNA map for all projects)")]
   pub async fn get_atlas(&self, _params: Parameters<NoParams>) -> Result<CallToolResult, McpError> {
       let result = tokio::task::spawn_blocking(move || {
           let ws = Workspace::discover()?;
           let atlas_path = ws.atlas_path();
           
           if !atlas_path.exists() {
               return Err(toad_core::ToadError::Other(
                   "ATLAS.json not found. Run 'toad manifest' to generate it.".to_string()
               ));
           }
           
           let content = std::fs::read_to_string(atlas_path)?;
           Ok::<_, toad_core::ToadError>(content)
       })
       .await
       .map_err(|e| crate::errors::toad_error_to_mcp(toad_core::ToadError::Other(e.to_string())))?
       .map_err(crate::errors::toad_error_to_mcp)?;
       
       Ok(CallToolResult::success(vec![Content::text(result)]))
   }
   ```

2. Add `get_manifest` tool (similar pattern, reads `MANIFEST.md`)

3. Add `get_project_context` tool (reads `shadows/{project}/CONTEXT.md`)

### Phase 2: Update Documentation (10 min)

**File:** `docs/guides/MCP.md`

1. Expand "Available Tools" section to include:
   - `get_atlas`
   - `get_manifest`
   - `get_project_context`
   - `get_active_context`
   - `list_contexts`
   - `switch_context`
   - `get_project_dna`
   - `search_projects_by_dna`
   - `compare_projects`

2. Add "Common Workflows" section:

   ```markdown
   ## Common Workflows
   
   ### Get Full Ecosystem Context
   1. `get_ecosystem_summary` — High-level overview
   2. `get_manifest` — Detailed project table
   3. `get_atlas` — DNA map for pattern matching
   
   ### Analyze a Specific Project
   1. `get_project_detail` — Basic metadata
   2. `get_project_context` — Deep dive with entry points
   3. `get_project_dna` — Structural patterns
   
   ### Find Projects by Capability
   1. `search_projects_by_dna` with query: "async"
   2. Filter results by stack or activity
   3. `get_project_context` for matches
   
   ### Plan a Migration
   1. `compare_projects` with source/target
   2. `get_project_context` for both projects
   3. Review compatibility score and mismatches
   ```

### Phase 3: Testing (5 min)

1. Run `cargo build -p toad-mcp`
2. Test each new tool via MCP client or manual stdio
3. Verify error messages for missing artifacts

---

## Success Criteria

- [ ] `get_atlas` tool returns `ATLAS.json` content
- [ ] `get_manifest` tool returns `MANIFEST.md` content
- [ ] `get_project_context` tool returns project-specific `CONTEXT.md`
- [ ] All tools return helpful errors when artifacts are missing
- [ ] `docs/guides/MCP.md` documents all 16 tools
- [ ] "Common Workflows" section provides clear examples
- [ ] MCP server builds and passes `cargo check`

---

## Integration Points

- **Depends on:** `toad-core::Workspace` (for path resolution)
- **Consumed by:** MCP clients (Windsurf, Cursor, Claude Desktop)
- **Documentation:** `docs/guides/MCP.md`

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Artifacts don't exist | Return clear error with `toad manifest` suggestion |
| Large file sizes | ATLAS/MANIFEST are already token-budgeted by `toad manifest` |
| Stale data | MCP guide already warns about staleness |

---

## Future Enhancements (v1.2.0+)

- **Batch operations tool** — Execute `toad do` via MCP
- **Resource endpoints** — Expose shadows/ as browsable resources
- **Prompt templates** — "Analyze ecosystem" workflow
